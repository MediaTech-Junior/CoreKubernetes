# 2장: 왜 파드인가?

## 파드

노드에서 실행되는 하나 이상의 컨테이너 집합.

### 컨테이너를 파드로 묶어쓰는 이유

 - **묶은 컨테이너끼리 서로 통신할 수 있게 한다.** 동일한 리소스나 네트워크를 공유해서 연관된 컨테이너끼리 쉽게 통신할 수 있게 한다.
 - **컨테이너들을 그룹화해서 하나의 앱 단위로 간주한다.** 복제할 때도 연관된 컨테이너들이 함께 복제되고, 마치 하나의 VM에서 실행되는 것 처럼 동작한다. 

### 리눅스 네임스페이스

하나의 시스템에서 여러 독립된 환경을 운영하는 가상화 기술

 - Docker 컨테이너 가상화의 기반이 되는 기술
   - `IPC`, `mnt`, `net`, `pid`, `pid_for_children`, `uts` 네임스페이스를 사용한다.
 - Docker에서 네임스페이스는 호스트 네임, 네트워크 환경, 마운트 지점 등 리소스를 분리하는데에 사용된다.
 - 파드에 **리소스 제한을 걸고**, **격리된 환경(네트워크, 마운트 등...)을 제공하기 위해**서 이 기술이 필요하다. 

## 워커 노드

파드가 실행되는 워커 머신

 - 하나의 노드에 여러 파드가 올라갈 수 있다.
 - 서로 다른 환경(IDC, ...)에 설치될 수도 있다.

### kubelet

노드에서 컨테이너를 관리하는 프로세스

 - 쿠버네티스 API 서버와 통신한다.
 - 파드를 생성하고 정상 동작하는지 확인한다.

### kube-proxy

클러스터 내부에서 네트워크 요청을 전달하는 프로세스

 - 파드의 IP는 매번 바뀐다. 외부에서 파드에 접근하려면 매번 바뀌는 IP때문에 곤란할 것.
 - `kube-proxy`는 **서비스**를 구현하는 프로세스
   - 포트를 사용해 구분하거나, 로드벨런싱하는 등... 

## 컨트롤 플레인 (마스터 노드)

클러스터 관리, 이벤트 처리와 같은 두뇌 역할을 수행하는 노드

 - 클러스터에 관한 결정(스케줄링 등...)을 수행한다.
 - 이벤트(replica 불충족)을 감지하고 대응한다.
   - 파드가 부족하면 더 생성한다.

### kube-apiserver

쿠버네티스 API를 노출하는 REST API 서버 프로세스

 - 클러스터를 통제하기 위한 각종 API를 제공한다.
 - `etcd`와 통신하는 유일한 컴포넌트다.

### etcd

모든 클러스터 데이터를 담는 key-value 형태의 저장소

 - 쿠버네티스는 로드벨런싱, 스케줄링, 모니터링 등의 조율을 수행한다.
 - 조율을 위해서는 클러스터의 상태(노드, 파드, 앱 인스턴스 등)를 알아야 한다.
 - 클러스터의 상태가 `etcd`에 저장된다.

### kube-scheduler

새로 생성된 파드를 탐지하고, 실행 계획을 수립하는 프로세스

 - 파드가 생성되면, 이 스케줄러에 의해 실행될 노드가 배정된다.
 - 노드 배정에는 여러 요소가 고려된다.
   - 리소스 요구 사항
   - 하드웨어/소프트웨어/정책적 제약
   - affinity, anti-affinity 명세
   - 데이터 지역성
   - 워크로드간 간섭
   - 데드라인

### kube-controller-manager

컨트롤러를 실행, 관리하는 프로세스

 - 컨트롤러는 `현재 상태를 감시하고, 상태를 조절하는 루프 시스템`를 의미한다.
   - 에어컨과 유사하다. 온도가 낮아지면 잠시 가동을 멈추다가, 다시 더워지면 가동하는 방식으로 동작한다.
 - 예를 들어 노드 컨트롤러는 노드가 다운되면, 통지하고 대응하는 컨트롤러이다.

### cloud-controller-manager

여러 클라우드 서비스 제공자와 쿠버네티스 컨트롤러들을 연계해서 사용하게 해주는 프로세스

 - **노드 컨트롤러**: 새로운 서버가 생기면 업데이트해주는 컨트롤러
 - **라우트 컨트롤러**: 클라우드상 컨테이너들이 서로 통신할 수 있도록 네트워크 라우트를 구성해주는 컨트롤러
 - **서비스 컨트롤러**: 로드벨런서, 네트워크 패킷 필터링 등을 필요할 때 생성, 갱신, 삭제해주는 컨트롤러

## 확장

파드 확장은 고가용성을 위해 필요한 기본 메커니즘이다. 쿠버네티스를 쉽게 확장할 수 있도록 지원한다. `kubectl scale`을 활용해서 파드를 늘리거나 줄일 수 있다.

### 확장 실패시 컨트롤러의 대응

컨트롤러는 파드나 노드와 주기적으로 하트 비트를 주고받으며 상태를 모니터링한다. 만약 파드나 노드를 확장하려는데 실패한다면?

 - **파드 중단**: `kubelet`이 파드 재시작을 시도한다.
 - **노드 중단**: 오프라인으로 전환하고(파드 안받는다), 파드들을 다른 노드에 스케줄링한다.

### 자동 확장

스파이크 트래픽이 들어오면, 쿠버네티스는 여러 형식의 자동 확장을 지원한다.

 - 파드를 더 많이 만들기
 - 파드에 리소스를 더 많이 주기
 - 노드를 더 많이 만들기